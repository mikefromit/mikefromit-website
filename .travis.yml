language: python
python:
  - '3.6'
dist: trusty
sudo: required
services:
  - redis-server
  - docker
before_install:
  # Remove the PostgreSQL installed by Travis
  - sudo apt-get purge pgdg-keyring '^postgresql.*' -y
  - sudo apt-get autoremove -y -qq
  - sudo rm -rf /etc/postgresql
  - sudo rm -rf /var/lib/postgresql
  - sudo rm -f /etc/apt/sources.list.d/pgdg-source.list
install:
  - docker-compose -f travis-compose.yml up -d
before_script:
  # Install the packages needed for development
  - docker exec mikefromitwebsite_web_1 /bin/sh -c "cd/app;pip install .[dev]"
script:
  - docker exec mikefromitwebsite_web_1 /bin/sh -c "cd /app;python setup.py test"
after_success:
  - docker exec mikefromitwebsite_web_1 /bin/sh -c "cd /app;codecov"
  - docker-compose down
  - docker build -t registry.heroku.com/mikefromit .
  - if [ "$TRAVIS_BRANCH" == "master" ]; then
    docker login -u "$HEROKU_USERNAME" -p "$HEROKU_API_KEY" "$HEROKU_REGISTRY_URL";
    docker push registry.heroku.com/mikefromit;
    fi
